//══════════════════════════════════════════════════════════════════════════════════════════════════
// QUERY: CVE-2026-20952/20953 - Microsoft Office Remote Code Execution (RCE) Detection
//══════════════════════════════════════════════════════════════════════════════════════════════════
// Version: 1.0
// Author: Cybersecurity Operations
// Last Updated: 2026-01-21
//
// DESCRIPTION:
// Identifies potential exploitation of CVE-2026-20952 and CVE-2026-20953, which involve 
// Remote Code Execution (RCE) vulnerabilities in Microsoft Office products. The query 
// monitors for Microsoft Word, Excel, PowerPoint, or Outlook spawning suspicious 
// child processes, such as script runners (PowerShell, MSHTA) or system administration 
// tools (Certutil, Schtasks). It incorporates prevalence scoring to highlight rare 
// execution patterns that may indicate targeted exploitation.
//
// VULNERABILITY DETAILS:
// CVE: CVE-2026-20952, CVE-2026-20953
// CVSS: 8.8 (High)
// Type: Remote Code Execution (RCE) / Logic Flaw
// Status: ACTIVELY EXPLOITED IN THE WILD
// Patched: January 13, 2026 (Microsoft Patch Tuesday)
// CISA KEV: Added with remediation deadline of February 3, 2026
//
// EXPLOITATION REQUIREMENTS:
// - User opens a specially crafted Office document or previews an email in Outlook
// - No administrative privileges required for initial execution
// - Network connectivity required for second-stage payload delivery
// - Bypasses standard Office Protected View in specific configurations
//
// USE CASES:
// - Detect "Living off the Land" (LotL) activity originating from Office suite
// - Identify rare process ancestry patterns in high-user-count environments
// - Track lateral movement attempts following an Office-based initial access
// - Correlate suspicious command lines with low-prevalence execution counts
//
// MITRE ATT&CK MAPPING:
// Technique: T1204.002 - User Execution: Malicious File
// Technique: T1059.001 - Command and Scripting Interpreter: PowerShell
// Tactics: Initial Access, Execution
//
// DATA SOURCE:
// Event Type: ProcessRollup2
// Required Fields: ParentBaseFileName, FileName, CommandLine, ComputerName, aid, @timestamp
// Sensor: CrowdStrike Falcon EDR
//
// AFFECTED SYSTEMS:
// - Microsoft Office 2019, 2021, LTSC
// - Microsoft 365 Apps for Enterprise
// - Windows 10 & 11 (All supported versions)
//
// FALSE POSITIVES:
// - Administrative scripts used for automated document processing
// - Security software or inventory agents triggering child processes
// - Legacy internal applications that use MSHTA or CMD to launch Office add-ins
// - User-initiated exports (e.g., "Save as PDF" calling system components)
//
// INVESTIGATION NOTES:
// 1. IMMEDIATE: Review the CommandLine for URLs, Base64 strings, or file paths in \Temp\
// 2. Verify the ParentProcessId to ensure the process was a direct child of the Office app
// 3. Check for network connections (NetworkReceiveMS/NetworkConnectMS) from the child process
// 4. Use "Timeline" view to see if any files were written to disk immediately after execution
// 5. Cross-reference the 'aid' with other detections to see if this is an isolated event
// 6. Inspect the document metadata if the file is available via Real Time Response (RTR)
// 7. Look for subsequent 'Identity' events indicating credential theft (e.g., LSASS access)
// 8. Analyze prevalence: Is this a global event or restricted to a single department?
//
// TUNING RECOMMENDATIONS:
// - Whitelist known-good administrative "CommandLines" used for business automation
// - Filter out 'outlook.exe' if it frequently spawns 'browser' processes for help links
// - Increase the 'limit' on 'collect' if troubleshooting across a very large fleet
// - Add a filter for 'UserSid' to exclude known service accounts
//
// REMEDIATION:
// Priority: CRITICAL (CISA KEV Compliance)
// Action: Apply January 2026 Security Updates to all Office installations
// Patches: KB5049912 (or version-specific equivalent)
//
// QUERY LOGIC:
// 1. Filters for Windows process events (ProcessRollup2)
// 2. Normalizes file names to lowercase for consistent matching
// 3. Targets specific Office binaries as the parent process
// 4. Matches child processes against a list of known "Dual-Use" or "LOLBins"
// 5. Aggregates data by command line to calculate a "Prevalence" count
// 6. Sorts by the lowest frequency to bubble up the most suspicious activity
//
// REFERENCES:
// - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2026-20952
// - https://www.cisa.gov/known-exploited-vulnerabilities-catalog
// - https://www.crowdstrike.com/blog/patch-tuesday-analysis-january-2026/
//
//══════════════════════════════════════════════════════════════════════════════════════════════════

#event_simpleName=ProcessRollup2 event_platform=Win
| ParentBaseFileName:=lower(ParentBaseFileName)
| in(field="ParentBaseFileName", values=["winword.exe", "excel.exe", "powerpnt.exe", "outlook.exe"])
| FileName:=lower(FileName)
// Focus on script runners and system tools
| in(field="FileName", values=["cmd.exe", "powershell.exe", "pwsh.exe", "wscript.exe", "cscript.exe", "mshta.exe", "scrcons.exe", "schtasks.exe", "regsvr32.exe", "certutil.exe", "bitsadmin.exe"])
| groupBy([ParentBaseFileName, FileName, CommandLine], function=([count(aid, as=ExecutionCount), collect(ComputerName, limit=10)]))
| sort(ExecutionCount, order=asc)

//══════════════════════════════════════════════════════════════════════════════════════════════════
// ENHANCEMENT OPTIONS:
//
// Add network correlation (detect C2 callbacks):
// | join(query={
//      #event_simpleName=/^(NetworkConnect|DnsRequest)/
//   }, field=aid, include=[RemoteAddressIP4, DomainName], start=-5m, end=+5m)
//
// Filter by specific sub-directories (often used by exploits):
// | CommandLine=/\\(Users\\Public|AppData\\Local\\Temp|ProgramData)\\.*$/i
//
// Add prevalence scoring against the last 30 days:
// | bucket(@timestamp, span=30d)
// | groupBy([CommandLine], function=count(aid, as=GlobalMonthlyCount))
// | test(GlobalMonthlyCount < 5)
//
//══════════════════════════════════════════════════════════════════════════════════════════════════
